# GitLab CI/CD Pipeline for GrimRepo Scripts
# RSR Bronze Compliance

variables:
  NODE_VERSION: "20"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"

# Cache node_modules between jobs
cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm
    - node_modules

# Stages
stages:
  - install
  - validate
  - test
  - build
  - security
  - deploy

# Install dependencies
install:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - npm ci --prefer-offline
  artifacts:
    paths:
      - node_modules
    expire_in: 1 hour

# Type checking
typecheck:
  stage: validate
  image: node:${NODE_VERSION}
  dependencies:
    - install
  script:
    - npm run typecheck
  allow_failure: false

# Linting
lint:
  stage: validate
  image: node:${NODE_VERSION}
  dependencies:
    - install
  script:
    - npm run lint
  allow_failure: false

# Code formatting check
format-check:
  stage: validate
  image: node:${NODE_VERSION}
  dependencies:
    - install
  script:
    - npm run format:check
  allow_failure: false

# Unit tests
test:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: coverage/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage
    expire_in: 7 days
  allow_failure: false

# Test coverage report
coverage:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install
  script:
    - npm run test:coverage
    - echo "Coverage report generated"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    paths:
      - coverage
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 30 days

# Build
build:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - install
  script:
    - npm run build
    - ls -lah dist/
  artifacts:
    paths:
      - dist
    expire_in: 7 days
  allow_failure: false

# RSR compliance verification
rsr-compliance:
  stage: validate
  image: alpine:latest
  script:
    - echo "ðŸ… Verifying RSR Bronze Compliance..."
    - |
      check_file() {
        if [ -f "$1" ]; then
          echo "  âœ“ $1"
          return 0
        else
          echo "  âœ— $1 (MISSING)"
          return 1
        fi
      }

      FAILED=0

      echo ""
      echo "ðŸ“„ Required Documentation:"
      check_file "README.md" || FAILED=1
      check_file "LICENSE.txt" || FAILED=1
      check_file "SECURITY.md" || FAILED=1
      check_file "CONTRIBUTING.md" || FAILED=1
      check_file "CODE_OF_CONDUCT.md" || FAILED=1
      check_file "MAINTAINERS.md" || FAILED=1
      check_file "CHANGELOG.md" || FAILED=1

      echo ""
      echo "ðŸ” .well-known Directory:"
      check_file ".well-known/security.txt" || FAILED=1
      check_file ".well-known/ai.txt" || FAILED=1
      check_file ".well-known/humans.txt" || FAILED=1

      echo ""
      echo "ðŸ› ï¸  Build System:"
      check_file "package.json" || FAILED=1
      check_file "tsconfig.json" || FAILED=1
      check_file "justfile" || FAILED=1
      check_file "flake.nix" || FAILED=1

      echo ""
      echo "ðŸ”„ CI/CD:"
      check_file ".gitlab-ci.yml" || FAILED=1

      echo ""
      if [ $FAILED -eq 0 ]; then
        echo "âœ… RSR Bronze Compliance: PASSED"
        exit 0
      else
        echo "âŒ RSR Bronze Compliance: FAILED"
        exit 1
      fi
  allow_failure: false

# Security: SAST (Static Application Security Testing)
sast:
  stage: security
  image: node:${NODE_VERSION}
  dependencies:
    - install
  script:
    - npm audit --audit-level=moderate
  allow_failure: true

# Security: Secret Detection
secret_detection:
  stage: security
  variables:
    SECRET_DETECTION_ENABLED: 'true'

# Security: Dependency Scanning
dependency_scanning:
  stage: security
  allow_failure: true

# Pages (documentation)
pages:
  stage: deploy
  image: node:${NODE_VERSION}
  dependencies:
    - coverage
  script:
    - mkdir -p public
    - cp -r coverage public/coverage
    - |
      cat > public/index.html <<EOF
      <!DOCTYPE html>
      <html>
      <head>
        <title>GrimRepo Scripts - CI Reports</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: system-ui; max-width: 800px; margin: 50px auto; padding: 20px; }
          h1 { color: #333; }
          a { color: #1976d2; text-decoration: none; }
          a:hover { text-decoration: underline; }
          .badge { display: inline-block; padding: 5px 10px; background: #4caf50; color: white; border-radius: 3px; margin: 5px; }
        </style>
      </head>
      <body>
        <h1>ðŸ“Š GrimRepo Scripts - CI Reports</h1>
        <p><span class="badge">RSR Bronze Compliant</span></p>
        <h2>Available Reports:</h2>
        <ul>
          <li><a href="coverage/">Test Coverage Report</a></li>
        </ul>
        <p>Generated by GitLab CI/CD</p>
      </body>
      </html>
      EOF
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main

# Include GitLab security templates
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
