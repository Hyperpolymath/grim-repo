// Generated by ReScript, PLEASE EDIT WITH CARE

import * as GrimCore from "../../core/GrimCore.mjs";
import * as Belt_Array from "rescript/lib/es6/belt_Array.js";
import * as Js_promise from "rescript/lib/es6/js_promise.js";
import * as Belt_Option from "rescript/lib/es6/belt_Option.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";

var scriptInfo_matches = [
  "*://gitlab.com/*",
  "*://*.gitlab.io/*"
];

var scriptInfo = {
  name: "grim-gitlab-enhanced",
  version: "1.0.0",
  description: "RSR-focused GitLab enhancements",
  matches: scriptInfo_matches
};

var tier1Languages = [
  [
    "Rust",
    "ü¶Ä"
  ],
  [
    "Elixir",
    "üíß"
  ],
  [
    "Zig",
    "‚ö°"
  ],
  [
    "Ada",
    "üîß"
  ],
  [
    "SPARK",
    "üîß"
  ],
  [
    "Haskell",
    "Œª"
  ],
  [
    "ReScript",
    "üìú"
  ],
  [
    "OCaml",
    "üê´"
  ]
];

var tier2Languages = [
  [
    "Nickel",
    "üî©"
  ],
  [
    "Racket",
    "üéæ"
  ],
  [
    "Scheme",
    "Œª"
  ],
  [
    "Guile",
    "Œª"
  ],
  [
    "Nix",
    "‚ùÑÔ∏è"
  ],
  [
    "Dhall",
    "üìã"
  ]
];

var prohibitedLanguages = [
  [
    "TypeScript",
    "üö´"
  ],
  [
    "JavaScript",
    "üö´"
  ],
  [
    "Python",
    "üêç"
  ],
  [
    "Go",
    "üö´"
  ],
  [
    "CUE",
    "üö´"
  ]
];

function getLanguageTier(lang) {
  var normalized = lang.toLowerCase();
  var findIn = function (list, tier) {
    return Belt_Option.map(Belt_Array.getBy(list, (function (param) {
                      return param[0].toLowerCase() === normalized;
                    })), (function (param) {
                  return [
                          tier,
                          param[1]
                        ];
                }));
  };
  return Belt_Option.getWithDefault(Belt_Option.orElse(Belt_Option.orElse(findIn(tier1Languages, "Tier1"), findIn(tier2Languages, "Tier2")), findIn(prohibitedLanguages, "Prohibited")), [
              "Unknown",
              "üì¶"
            ]);
}

var css = "\n  .grim-rsr-badge {\n    display: inline-flex;\n    align-items: center;\n    gap: 4px;\n    padding: 2px 8px;\n    border-radius: 4px;\n    font-size: 11px;\n    font-weight: 600;\n    margin-left: 8px;\n  }\n  .grim-rsr-tier1 { background: #d4edda; color: #155724; }\n  .grim-rsr-tier2 { background: #fff3cd; color: #856404; }\n  .grim-rsr-prohibited { background: #f8d7da; color: #721c24; }\n  .grim-rsr-unknown { background: #e9ecef; color: #495057; }\n\n  .grim-lang-badge {\n    display: inline-flex;\n    align-items: center;\n    gap: 2px;\n    padding: 1px 6px;\n    border-radius: 3px;\n    font-size: 10px;\n    margin: 2px;\n  }\n\n  .grim-state-viewer {\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    background: #1e1e1e;\n    color: #d4d4d4;\n    padding: 20px;\n    border-radius: 8px;\n    max-width: 600px;\n    max-height: 80vh;\n    overflow: auto;\n    z-index: 100000;\n    font-family: 'JetBrains Mono', 'Fira Code', monospace;\n    font-size: 13px;\n    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n  }\n  .grim-state-viewer pre {\n    margin: 0;\n    white-space: pre-wrap;\n  }\n  .grim-state-viewer-close {\n    position: absolute;\n    top: 10px;\n    right: 10px;\n    cursor: pointer;\n    font-size: 18px;\n    opacity: 0.6;\n  }\n  .grim-state-viewer-close:hover { opacity: 1; }\n  .grim-state-viewer-title {\n    font-weight: 600;\n    margin-bottom: 12px;\n    color: #569cd6;\n  }\n\n  .grim-rsr-indicator {\n    position: fixed;\n    top: 60px;\n    right: 20px;\n    z-index: 99990;\n    background: white;\n    border: 1px solid #dfe6e9;\n    border-radius: 8px;\n    padding: 12px 16px;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n    font-size: 12px;\n  }\n  .grim-rsr-indicator-row {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    margin: 4px 0;\n  }\n  .grim-rsr-indicator-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n  }\n  .grim-rsr-indicator-dot.green { background: #27ae60; }\n  .grim-rsr-indicator-dot.yellow { background: #f39c12; }\n  .grim-rsr-indicator-dot.red { background: #e74c3c; }\n  .grim-rsr-indicator-dot.gray { background: #95a5a6; }\n";

function isRepoPage() {
  var path = location.pathname;
  var parts = Belt_Array.keep(path.split("/"), (function (s) {
          return s !== "";
        }));
  if (parts.length >= 2 && !path.includes("/explore")) {
    return !path.includes("/dashboard");
  } else {
    return false;
  }
}

function getRepoPath() {
  if (!isRepoPage()) {
    return ;
  }
  var path = location.pathname;
  var parts = Belt_Array.keep(path.split("/"), (function (s) {
          return s !== "";
        }));
  return Belt_Array.slice(parts, 0, 3).join("/");
}

function checkFile(repoPath, filePath) {
  var url = "https://gitlab.com/" + repoPath + "/-/raw/main/" + filePath;
  var __x = (function (__x) {
        return Js_promise.then_((function (resp) {
                      return Promise.resolve(resp.status === 200);
                    }), __x);
      })(GrimCore.HTTP.$$fetch(undefined, undefined, url));
  return Js_promise.$$catch((function (param) {
                return Promise.resolve(false);
              }), __x);
}

function fetchStateScm(repoPath) {
  var url = "https://gitlab.com/" + repoPath + "/-/raw/main/STATE.scm";
  var __x = (function (__x) {
        return Js_promise.then_((function (resp) {
                      if (resp.status === 200) {
                        return Promise.resolve(resp.responseText);
                      } else {
                        return Promise.resolve(undefined);
                      }
                    }), __x);
      })(GrimCore.HTTP.$$fetch(undefined, undefined, url));
  return Js_promise.$$catch((function (param) {
                return Promise.resolve(undefined);
              }), __x);
}

function getRepoLanguages() {
  var langElements = GrimCore.DOM.queryAll(".repository-language-bar-tooltip, [data-testid='language-stats'] span");
  return Belt_Array.keep(Belt_Array.map(langElements, (function (el) {
                    return el.textContent.trim();
                  })), (function (s) {
                if (s !== "") {
                  return !s.includes("%");
                } else {
                  return false;
                }
              }));
}

function createRsrBadge(tier, text) {
  var className;
  switch (tier) {
    case "Tier1" :
        className = "grim-rsr-badge grim-rsr-tier1";
        break;
    case "Tier2" :
        className = "grim-rsr-badge grim-rsr-tier2";
        break;
    case "Prohibited" :
        className = "grim-rsr-badge grim-rsr-prohibited";
        break;
    case "Unknown" :
        className = "grim-rsr-badge grim-rsr-unknown";
        break;
    
  }
  var badge = GrimCore.DOM.create("span", className, undefined);
  badge.textContent = text;
  return badge;
}

function createLanguageBadge(lang) {
  var match = getLanguageTier(lang);
  var className;
  switch (match[0]) {
    case "Tier1" :
        className = "grim-lang-badge grim-rsr-tier1";
        break;
    case "Tier2" :
        className = "grim-lang-badge grim-rsr-tier2";
        break;
    case "Prohibited" :
        className = "grim-lang-badge grim-rsr-prohibited";
        break;
    case "Unknown" :
        className = "grim-lang-badge grim-rsr-unknown";
        break;
    
  }
  var badge = GrimCore.DOM.create("span", className, undefined);
  badge.textContent = match[1] + " " + lang;
  return badge;
}

function showStateViewer(content) {
  var el = GrimCore.DOM.query(".grim-state-viewer");
  if (el !== undefined) {
    Caml_option.valFromOption(el).remove();
  }
  var viewer = GrimCore.DOM.create("div", "grim-state-viewer", undefined);
  viewer.innerHTML = "\n    <span class=\"grim-state-viewer-close\">‚úï</span>\n    <div class=\"grim-state-viewer-title\">üìã STATE.scm</div>\n    <pre>" + content + "</pre>\n  ";
  document.body.appendChild(viewer);
  var closeBtn = GrimCore.DOM.query(".grim-state-viewer-close");
  if (closeBtn !== undefined) {
    Caml_option.valFromOption(closeBtn).addEventListener("click", (function (param) {
            viewer.remove();
          }));
  }
  document.body.addEventListener("keydown", (function ($$event) {
          if ((event.key === "Escape")) {
            viewer.remove();
            return ;
          }
          
        }));
}

function createRsrIndicator(info) {
  var indicator = GrimCore.DOM.create("div", "grim-rsr-indicator", undefined);
  var rows = [
    [
      info.hasStateScm,
      "STATE.scm"
    ],
    [
      info.hasAibdp,
      "AIBDP"
    ]
  ];
  var rowsHtml = Belt_Array.map(rows, (function (param) {
            var present = param[0];
            var dotClass = present ? "green" : "gray";
            var status = present ? "‚úì" : "‚úó";
            return "<div class=\"grim-rsr-indicator-row\">\n      <span class=\"grim-rsr-indicator-dot " + dotClass + "\"></span>\n      <span>" + status + " " + param[1] + "</span>\n    </div>";
          })).join("");
  var hasTier1 = Belt_Array.some(info.languages, (function (l) {
          return l.tier === "Tier1";
        }));
  var hasProhibited = Belt_Array.some(info.languages, (function (l) {
          return l.tier === "Prohibited";
        }));
  var complianceClass = hasProhibited ? "red" : (
      hasTier1 ? "green" : "yellow"
    );
  var complianceText = hasProhibited ? "‚ö†Ô∏è Has prohibited languages" : (
      hasTier1 ? "‚úì RSR Tier 1" : "‚óã Unknown tier"
    );
  indicator.innerHTML = "\n    <strong>RSR Status</strong>\n    " + rowsHtml + "\n    <div class=\"grim-rsr-indicator-row\">\n      <span class=\"grim-rsr-indicator-dot " + complianceClass + "\"></span>\n      <span>" + complianceText + "</span>\n    </div>\n  ";
  document.body.appendChild(indicator);
}

function enhanceRepoPage(repoPath) {
  GrimCore.Log.info("Enhancing repo: " + repoPath);
  ((function (__x) {
          return Js_promise.then_((function (param) {
                        var hasAibdp = param[1];
                        var hasState = param[0];
                        var languages = Belt_Array.map(getRepoLanguages(), (function (name) {
                                var match = getLanguageTier(name);
                                return {
                                        name: name,
                                        tier: match[0],
                                        emoji: match[1]
                                      };
                              }));
                        var info_rsrCompliant = hasState && hasAibdp;
                        var info = {
                          hasStateScm: hasState,
                          hasAibdp: hasAibdp,
                          languages: languages,
                          rsrCompliant: info_rsrCompliant
                        };
                        createRsrIndicator(info);
                        if (hasState) {
                          GM_registerMenuCommand("View STATE.scm", (function () {
                                  ((function (__x) {
                                          return Js_promise.then_((function (content) {
                                                        if (content !== undefined) {
                                                          showStateViewer(content);
                                                        } else {
                                                          GrimCore.UI.toast("Failed to load STATE.scm", undefined);
                                                        }
                                                        return Promise.resolve();
                                                      }), __x);
                                        })(fetchStateScm(repoPath)));
                                }));
                        }
                        return Promise.resolve();
                      }), __x);
        })(Promise.all([
              checkFile(repoPath, "STATE.scm"),
              checkFile(repoPath, ".well-known/aibdp.json")
            ])));
  var langBar = GrimCore.DOM.query(".repository-languages, [data-testid='language-stats']");
  if (langBar === undefined) {
    return ;
  }
  var el = Caml_option.valFromOption(langBar);
  var langNames = getRepoLanguages();
  Belt_Array.forEach(langNames, (function (name) {
          var badge = createLanguageBadge(name);
          el.appendChild(badge);
        }));
}

function enhanceProjectList() {
  var projectCards = GrimCore.DOM.queryAll(".project-card, .project-row");
  Belt_Array.forEach(projectCards, (function (card) {
          var link = (card.querySelector('a.project'));
          if (!(link == null)) {
            ((link.getAttribute('href')));
            return ;
          }
          
        }));
}

function run() {
  if (!GrimCore.$$URL.isGitLab()) {
    return ;
  }
  GrimCore.Log.info("GitLab Enhanced running");
  GM_addStyle(css);
  var repoPath = getRepoPath();
  if (repoPath !== undefined) {
    enhanceRepoPage(repoPath);
  } else {
    enhanceProjectList();
  }
  GM_registerMenuCommand("Show RSR Info", (function () {
          var path = getRepoPath();
          if (path !== undefined) {
            return GrimCore.UI.toast("Repo: " + path, undefined);
          } else {
            return GrimCore.UI.toast("Not on a repo page", undefined);
          }
        }));
}

GrimCore.Registry.register("grim-gitlab-enhanced", scriptInfo);

if ((document.readyState === "complete")) {
  run();
} else {
  document.body.addEventListener("DOMContentLoaded", (function (param) {
          run();
        }));
}

export {
  scriptInfo ,
  tier1Languages ,
  tier2Languages ,
  prohibitedLanguages ,
  getLanguageTier ,
  css ,
  isRepoPage ,
  getRepoPath ,
  checkFile ,
  fetchStateScm ,
  getRepoLanguages ,
  createRsrBadge ,
  createLanguageBadge ,
  showStateViewer ,
  createRsrIndicator ,
  enhanceRepoPage ,
  enhanceProjectList ,
  run ,
}
/*  Not a pure module */
