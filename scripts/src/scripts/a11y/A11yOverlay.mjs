// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Belt_Int from "rescript/lib/es6/belt_Int.js";
import * as GrimCore from "../../core/GrimCore.mjs";
import * as Belt_Array from "rescript/lib/es6/belt_Array.js";
import * as Belt_Option from "rescript/lib/es6/belt_Option.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";

var scriptInfo_matches = ["*://*/*"];

var scriptInfo = {
  name: "grim-a11y-overlay",
  version: "1.0.0",
  description: "Accessibility testing overlay with WCAG checks",
  matches: scriptInfo_matches
};

var wcag_1_1_1 = {
  id: "1.1.1",
  level: "A",
  title: "Non-text Content"
};

var wcag_1_4_3 = {
  id: "1.4.3",
  level: "AA",
  title: "Contrast (Minimum)"
};

var wcag_1_4_6 = {
  id: "1.4.6",
  level: "AAA",
  title: "Contrast (Enhanced)"
};

var wcag_1_3_1 = {
  id: "1.3.1",
  level: "A",
  title: "Info and Relationships"
};

var wcag_2_4_1 = {
  id: "2.4.1",
  level: "A",
  title: "Bypass Blocks"
};

var wcag_2_4_7 = {
  id: "2.4.7",
  level: "AA",
  title: "Focus Visible"
};

var wcag_4_1_2 = {
  id: "4.1.2",
  level: "A",
  title: "Name, Role, Value"
};

var css = "\n  .grim-a11y-overlay {\n    position: fixed;\n    top: 0;\n    right: 0;\n    width: 360px;\n    height: 100vh;\n    background: #ffffff;\n    border-left: 1px solid #dfe6e9;\n    z-index: 999999;\n    font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n    font-size: 13px;\n    display: flex;\n    flex-direction: column;\n    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);\n  }\n  .grim-a11y-header {\n    padding: 16px;\n    border-bottom: 1px solid #dfe6e9;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n  .grim-a11y-header h3 {\n    margin: 0;\n    font-size: 16px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  }\n  .grim-a11y-close {\n    cursor: pointer;\n    font-size: 20px;\n    opacity: 0.6;\n    transition: opacity 0.2s;\n  }\n  .grim-a11y-close:hover { opacity: 1; }\n  .grim-a11y-summary {\n    padding: 12px 16px;\n    background: #f8f9fa;\n    display: flex;\n    gap: 16px;\n    border-bottom: 1px solid #dfe6e9;\n  }\n  .grim-a11y-stat {\n    text-align: center;\n  }\n  .grim-a11y-stat-value {\n    font-size: 24px;\n    font-weight: 700;\n  }\n  .grim-a11y-stat-label {\n    font-size: 11px;\n    color: #636e72;\n    text-transform: uppercase;\n  }\n  .grim-a11y-stat-error .grim-a11y-stat-value { color: #e74c3c; }\n  .grim-a11y-stat-warning .grim-a11y-stat-value { color: #f39c12; }\n  .grim-a11y-stat-passed .grim-a11y-stat-value { color: #27ae60; }\n  .grim-a11y-issues {\n    flex: 1;\n    overflow-y: auto;\n    padding: 0;\n  }\n  .grim-a11y-issue {\n    padding: 12px 16px;\n    border-bottom: 1px solid #f1f3f4;\n    cursor: pointer;\n    transition: background 0.2s;\n  }\n  .grim-a11y-issue:hover {\n    background: #f8f9fa;\n  }\n  .grim-a11y-issue-header {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    margin-bottom: 4px;\n  }\n  .grim-a11y-issue-severity {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n  }\n  .grim-a11y-issue-severity.error { background: #e74c3c; }\n  .grim-a11y-issue-severity.warning { background: #f39c12; }\n  .grim-a11y-issue-severity.info { background: #3498db; }\n  .grim-a11y-issue-wcag {\n    font-size: 10px;\n    padding: 2px 6px;\n    background: #e9ecef;\n    border-radius: 3px;\n    color: #495057;\n  }\n  .grim-a11y-issue-message {\n    color: #2d3436;\n    line-height: 1.4;\n  }\n  .grim-a11y-issue-suggestion {\n    font-size: 11px;\n    color: #636e72;\n    margin-top: 4px;\n    font-style: italic;\n  }\n  .grim-a11y-highlight {\n    outline: 3px solid #e74c3c !important;\n    outline-offset: 2px !important;\n  }\n  .grim-a11y-highlight-warning {\n    outline: 3px solid #f39c12 !important;\n    outline-offset: 2px !important;\n  }\n  .grim-a11y-actions {\n    padding: 12px 16px;\n    border-top: 1px solid #dfe6e9;\n    display: flex;\n    gap: 8px;\n  }\n  .grim-a11y-btn {\n    flex: 1;\n    padding: 8px 12px;\n    border: none;\n    border-radius: 4px;\n    font-size: 12px;\n    cursor: pointer;\n    transition: background 0.2s;\n  }\n  .grim-a11y-btn-primary {\n    background: #3498db;\n    color: white;\n  }\n  .grim-a11y-btn-primary:hover { background: #2980b9; }\n  .grim-a11y-btn-secondary {\n    background: #e9ecef;\n    color: #495057;\n  }\n  .grim-a11y-btn-secondary:hover { background: #dee2e6; }\n";

function parseColor(color) {
  var rgbMatch = (color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/));
  if (rgbMatch == null) {
    var rgbaMatch = (color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*[\d.]+\)/));
    if (rgbaMatch == null) {
      return ;
    }
    var r = (parseFloat(rgbaMatch[1]));
    var g = (parseFloat(rgbaMatch[2]));
    var b = (parseFloat(rgbaMatch[3]));
    return [
            r,
            g,
            b
          ];
  }
  var r$1 = (parseFloat(rgbMatch[1]));
  var g$1 = (parseFloat(rgbMatch[2]));
  var b$1 = (parseFloat(rgbMatch[3]));
  return [
          r$1,
          g$1,
          b$1
        ];
}

function relativeLuminance(param) {
  var adjust = function (c) {
    var c$p = c / 255.0;
    if (c$p <= 0.03928) {
      return c$p / 12.92;
    } else {
      return Math.pow((c$p + 0.055) / 1.055, 2.4);
    }
  };
  return 0.2126 * adjust(param[0]) + 0.7152 * adjust(param[1]) + 0.0722 * adjust(param[2]);
}

function contrastRatio(l1, l2) {
  var lighter = Math.max(l1, l2);
  var darker = Math.min(l1, l2);
  return (lighter + 0.05) / (darker + 0.05);
}

function getElementColors(el) {
  getComputedStyle(el);
  var fg = style.color;
  var bg = style.backgroundColor;
  return [
          fg,
          bg
        ];
}

function checkImageAlt() {
  var images = GrimCore.DOM.queryAll("img");
  return Belt_Array.keepMap(images, (function (img) {
                var alt = img.getAttribute("alt");
                var src = Belt_Option.getWithDefault(Caml_option.nullable_to_opt(img.getAttribute("src")), "");
                if (src.includes("pixel") || src.includes("tracking")) {
                  return ;
                } else if (alt == null) {
                  return {
                          element: img,
                          severity: "Error",
                          message: "Image missing alt attribute",
                          wcag: wcag_1_1_1,
                          suggestion: "Add descriptive alt text or alt=\"\" for decorative images"
                        };
                } else if (alt === "") {
                  return {
                          element: img,
                          severity: "Info",
                          message: "Image has empty alt (decorative)",
                          wcag: wcag_1_1_1,
                          suggestion: undefined
                        };
                } else {
                  return ;
                }
              }));
}

function checkContrast() {
  var textElements = GrimCore.DOM.queryAll("p, span, a, h1, h2, h3, h4, h5, h6, li, td, th, label, button");
  return Belt_Array.keepMap(textElements, (function (el) {
                var match = getElementColors(el);
                if (match === undefined) {
                  return ;
                }
                var match$1 = parseColor(match[0]);
                var match$2 = parseColor(match[1]);
                if (match$1 === undefined) {
                  return ;
                }
                if (match$2 === undefined) {
                  return ;
                }
                var fgLum = relativeLuminance(match$1);
                var bgLum = relativeLuminance(match$2);
                var ratio = contrastRatio(fgLum, bgLum);
                if (ratio < 4.5) {
                  return {
                          element: el,
                          severity: "Error",
                          message: "Contrast ratio " + ratio.toFixed(2) + ":1 below 4.5:1 minimum",
                          wcag: wcag_1_4_3,
                          suggestion: "Increase contrast between text and background colors"
                        };
                } else if (ratio < 7.0) {
                  return {
                          element: el,
                          severity: "Warning",
                          message: "Contrast ratio " + ratio.toFixed(2) + ":1 below 7:1 (AAA)",
                          wcag: wcag_1_4_6,
                          suggestion: "Consider higher contrast for AAA compliance"
                        };
                } else {
                  return ;
                }
              }));
}

function checkFormLabels() {
  var inputs = GrimCore.DOM.queryAll("input, select, textarea");
  return Belt_Array.keepMap(inputs, (function (input) {
                var inputType = Belt_Option.getWithDefault(Caml_option.nullable_to_opt(input.getAttribute("type")), "text");
                if (inputType === "hidden" || inputType === "submit" || inputType === "button") {
                  return ;
                }
                var id = input.getAttribute("id");
                var ariaLabel = input.getAttribute("aria-label");
                var ariaLabelledBy = input.getAttribute("aria-labelledby");
                var hasLabel = (id == null) ? false : Belt_Option.isSome(GrimCore.DOM.query("label[for=\"" + id + "\"]"));
                if (!hasLabel && Belt_Option.isNone((ariaLabel == null) ? undefined : Caml_option.some(ariaLabel)) && Belt_Option.isNone((ariaLabelledBy == null) ? undefined : Caml_option.some(ariaLabelledBy))) {
                  return {
                          element: input,
                          severity: "Error",
                          message: "Form input missing associated label",
                          wcag: wcag_4_1_2,
                          suggestion: "Add <label for=\"id\"> or aria-label attribute"
                        };
                }
                
              }));
}

function checkHeadingHierarchy() {
  var headings = GrimCore.DOM.queryAll("h1, h2, h3, h4, h5, h6");
  var levels = Belt_Array.map(headings, (function (h) {
          var tag = h.tagName;
          var levelStr = tag.charAt(1);
          var level = Belt_Option.getWithDefault(Belt_Int.fromString(levelStr), 0);
          return [
                  h,
                  level
                ];
        }));
  var issues = [];
  var prevLevel = {
    contents: 0
  };
  Belt_Array.forEach(levels, (function (param) {
          var level = param[1];
          if (level > (prevLevel.contents + 1 | 0) && prevLevel.contents > 0) {
            issues.push({
                  element: param[0],
                  severity: "Warning",
                  message: "Skipped heading level: h" + prevLevel.contents.toString() + " to h" + level.toString(),
                  wcag: wcag_1_3_1,
                  suggestion: "Maintain sequential heading levels for screen reader navigation"
                });
          }
          prevLevel.contents = level;
        }));
  return issues;
}

function checkSkipLinks() {
  var skipLink = GrimCore.DOM.query("a[href='#main'], a[href='#content'], .skip-link, .skip-to-content");
  if (skipLink !== undefined) {
    return [];
  } else {
    return [{
              element: document.body,
              severity: "Warning",
              message: "No skip link found",
              wcag: wcag_2_4_1,
              suggestion: "Add a skip link at the start of the page to bypass navigation"
            }];
  }
}

function checkFocusIndicators() {
  var focusableElements = GrimCore.DOM.queryAll("a, button, input, select, textarea, [tabindex]");
  return Belt_Array.keepMap(focusableElements, (function (el) {
                getComputedStyle(el);
                var outline = style.outlineStyle;
                var boxShadow = style.boxShadow;
                if (outline === "none" && boxShadow === "none") {
                  return {
                          element: el,
                          severity: "Warning",
                          message: "Element may have no visible focus indicator",
                          wcag: wcag_2_4_7,
                          suggestion: "Ensure focus is visible with outline or box-shadow"
                        };
                }
                
              }));
}

function runAudit() {
  GrimCore.Log.info("Running accessibility audit");
  var allIssues = Belt_Array.concatMany([
        checkImageAlt(),
        checkContrast(),
        checkFormLabels(),
        checkHeadingHierarchy(),
        checkSkipLinks()
      ]);
  var errors = Belt_Array.keep(allIssues, (function (i) {
          return i.severity === "Error";
        })).length;
  var warnings = Belt_Array.keep(allIssues, (function (i) {
          return i.severity === "Warning";
        })).length;
  return {
          issues: allIssues,
          passed: 0,
          failed: errors,
          warnings: warnings
        };
}

function severityToClass(s) {
  switch (s) {
    case "Error" :
        return "error";
    case "Warning" :
        return "warning";
    case "Info" :
        return "info";
    
  }
}

function renderIssue(issue, index) {
  var s = issue.suggestion;
  var suggestion = s !== undefined ? "<div class=\"grim-a11y-issue-suggestion\">ðŸ’¡ " + s + "</div>" : "";
  return "<div class=\"grim-a11y-issue\" data-issue-index=\"" + index.toString() + "\">\n    <div class=\"grim-a11y-issue-header\">\n      <span class=\"grim-a11y-issue-severity " + severityToClass(issue.severity) + "\"></span>\n      <span class=\"grim-a11y-issue-wcag\">WCAG " + issue.wcag.id + " (" + issue.wcag.level + ")</span>\n    </div>\n    <div class=\"grim-a11y-issue-message\">" + issue.message + "</div>\n    " + suggestion + "\n  </div>";
}

function showOverlay(result) {
  var el = GrimCore.DOM.query(".grim-a11y-overlay");
  if (el !== undefined) {
    Caml_option.valFromOption(el).remove();
  }
  var overlay = GrimCore.DOM.create("div", "grim-a11y-overlay", undefined);
  var issuesHtml = Belt_Array.mapWithIndex(result.issues, (function (i, issue) {
            return renderIssue(issue, i);
          })).join("");
  overlay.innerHTML = "\n    <div class=\"grim-a11y-header\">\n      <h3>â™¿ Accessibility Audit</h3>\n      <span class=\"grim-a11y-close\">âœ•</span>\n    </div>\n    <div class=\"grim-a11y-summary\">\n      <div class=\"grim-a11y-stat grim-a11y-stat-error\">\n        <div class=\"grim-a11y-stat-value\">" + result.failed.toString() + "</div>\n        <div class=\"grim-a11y-stat-label\">Errors</div>\n      </div>\n      <div class=\"grim-a11y-stat grim-a11y-stat-warning\">\n        <div class=\"grim-a11y-stat-value\">" + result.warnings.toString() + "</div>\n        <div class=\"grim-a11y-stat-label\">Warnings</div>\n      </div>\n      <div class=\"grim-a11y-stat grim-a11y-stat-passed\">\n        <div class=\"grim-a11y-stat-value\">" + result.issues.length.toString() + "</div>\n        <div class=\"grim-a11y-stat-label\">Total</div>\n      </div>\n    </div>\n    <div class=\"grim-a11y-issues\">\n      " + issuesHtml + "\n    </div>\n    <div class=\"grim-a11y-actions\">\n      <button class=\"grim-a11y-btn grim-a11y-btn-primary\" id=\"grim-a11y-rerun\">\n        ðŸ”„ Re-run Audit\n      </button>\n      <button class=\"grim-a11y-btn grim-a11y-btn-secondary\" id=\"grim-a11y-export\">\n        ðŸ“‹ Export\n      </button>\n    </div>\n  ";
  document.body.appendChild(overlay);
  var btn = GrimCore.DOM.query(".grim-a11y-close");
  if (btn !== undefined) {
    Caml_option.valFromOption(btn).addEventListener("click", (function (param) {
            Belt_Array.forEach(GrimCore.DOM.queryAll(".grim-a11y-highlight, .grim-a11y-highlight-warning"), (function (el) {
                    el["classList.remove"]("grim-a11y-highlight");
                    el["classList.remove"]("grim-a11y-highlight-warning");
                  }));
            overlay.remove();
          }));
  }
  Belt_Array.forEach(GrimCore.DOM.queryAll(".grim-a11y-issue"), (function (issueEl) {
          issueEl.addEventListener("click", (function (param) {
                  var indexStr = issueEl.getAttribute("data-issue-index");
                  if (indexStr == null) {
                    return ;
                  }
                  var index = Belt_Option.getWithDefault(Belt_Int.fromString(indexStr), 0);
                  var issue = Belt_Array.get(result.issues, index);
                  if (issue === undefined) {
                    return ;
                  }
                  Belt_Array.forEach(GrimCore.DOM.queryAll(".grim-a11y-highlight, .grim-a11y-highlight-warning"), (function (el) {
                          el["classList.remove"]("grim-a11y-highlight");
                          el["classList.remove"]("grim-a11y-highlight-warning");
                        }));
                  var highlightClass = issue.severity === "Error" ? "grim-a11y-highlight" : "grim-a11y-highlight-warning";
                  issue.element["classList.add"](highlightClass);
                  ((issue.element.scrollIntoView({behavior: 'smooth', block: 'center'})));
                }));
        }));
  var btn$1 = GrimCore.DOM.query("#grim-a11y-rerun");
  if (btn$1 !== undefined) {
    Caml_option.valFromOption(btn$1).addEventListener("click", (function (param) {
            overlay.remove();
            run();
          }));
  }
  var btn$2 = GrimCore.DOM.query("#grim-a11y-export");
  if (btn$2 !== undefined) {
    Caml_option.valFromOption(btn$2).addEventListener("click", (function (param) {
            Belt_Array.map(result.issues, (function (issue) {
                      return "[" + severityToClass(issue.severity).toUpperCase() + "] WCAG " + issue.wcag.id + ": " + issue.message;
                    })).join("\n");
            ((navigator.clipboard.writeText(report)));
            GrimCore.UI.toast("Report copied to clipboard", undefined);
          }));
    return ;
  }
  
}

function run() {
  GrimCore.Log.info("A11y Overlay running");
  GM_addStyle(css);
  var result = runAudit();
  showOverlay(result);
}

GrimCore.Registry.register("grim-a11y-overlay", scriptInfo);

GM_registerMenuCommand("Run Accessibility Audit", run);

var wcag_2_4_6 = {
  id: "2.4.6",
  level: "AA",
  title: "Headings and Labels"
};

export {
  scriptInfo ,
  wcag_1_1_1 ,
  wcag_1_4_3 ,
  wcag_1_4_6 ,
  wcag_1_3_1 ,
  wcag_2_4_1 ,
  wcag_2_4_6 ,
  wcag_2_4_7 ,
  wcag_4_1_2 ,
  css ,
  parseColor ,
  relativeLuminance ,
  contrastRatio ,
  getElementColors ,
  checkImageAlt ,
  checkContrast ,
  checkFormLabels ,
  checkHeadingHierarchy ,
  checkSkipLinks ,
  checkFocusIndicators ,
  runAudit ,
  severityToClass ,
  renderIssue ,
  showOverlay ,
  run ,
}
/*  Not a pure module */
