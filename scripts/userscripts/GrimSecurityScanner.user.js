// ==UserScript==
// @name         GrimSecurityScanner
// @namespace    https://github.com/hyperpolymath
// @version      1.0.0
// @description  Security vulnerability detector for repositories
// @author       Jonathan D.A. Jewell <jonathan.jewell@open.ac.uk>
// @homepage     https://github.com/hyperpolymath/grimrepo-scripts
// @supportURL   https://github.com/hyperpolymath/grimrepo-scripts/issues
// @match        *://github.com/*/*
// @match        *://gitlab.com/*/*
// @grant        GM.getValue
// @grant        GM.setValue
// @grant        GM.addStyle
// @grant        GM.xmlHttpRequest
// @grant        GM.registerMenuCommand
// @license      PMPL-1.0-or-later
// @run-at       document-end
// ==/UserScript==

// Generated by ReScript, PLEASE EDIT WITH CARE

import * as GrimCore from "../../core/GrimCore.mjs";
import * as Belt_Array from "rescript/lib/es6/belt_Array.js";
import * as Belt_Option from "rescript/lib/es6/belt_Option.js";

var secretPatterns = [
  [
    "api[_-]?key",
    "API key"
  ],
  [
    "secret[_-]?key",
    "secret key"
  ],
  [
    "password\\s*=",
    "hardcoded password"
  ],
  [
    "token\\s*=",
    "authentication token"
  ],
  [
    "private[_-]?key",
    "private key"
  ],
  [
    "[a-z0-9]{32,}",
    "potential hash/key"
  ],
  [
    "ghp_[a-zA-Z0-9]{36}",
    "GitHub Personal Access Token"
  ],
  [
    "sk_live_[a-zA-Z0-9]{24,}",
    "Stripe secret key"
  ],
  [
    "AKIA[0-9A-Z]{16}",
    "AWS Access Key"
  ]
];

var dangerousPatterns = [
  [
    "eval\\(",
    "Use of eval()"
  ],
  [
    "exec\\(",
    "Use of exec()"
  ],
  [
    "system\\(",
    "System command execution"
  ],
  [
    "innerHTML\\s*=",
    "Potential XSS via innerHTML"
  ],
  [
    "document\\.write",
    "Use of document.write"
  ],
  [
    "dangerouslySetInnerHTML",
    "React dangerouslySetInnerHTML"
  ]
];

var insecureDependencies = [
  [
    "\"lodash\":\\s*\"<4\\.17\\.21\"",
    "Lodash < 4.17.21"
  ],
  [
    "\"axios\":\\s*\"<0\\.21\\.1\"",
    "Axios < 0.21.1"
  ],
  [
    "\"moment\":\\s*\".*\"",
    "Moment.js (deprecated)"
  ]
];

function detectSecrets(content, filename) {
  var issues = [];
  Belt_Array.forEach(secretPatterns, (function (param) {
          ((new RegExp(pattern, "gi")));
          if ((regex.test(content))) {
            return (issues.push(issue));
          }
          
        }));
  return issues;
}

function detectDangerousCode(content, filename) {
  var issues = [];
  Belt_Array.forEach(dangerousPatterns, (function (param) {
          ((new RegExp(pattern, "g")));
          if ((regex.test(content))) {
            return (issues.push(issue));
          }
          
        }));
  return issues;
}

function checkSecurityFiles() {
  var hasSecurityMd = Belt_Option.isSome(GrimCore.DOM.query("a[title='SECURITY.md']"));
  var hasCodeOfConduct = Belt_Option.isSome(GrimCore.DOM.query("a[title='CODE_OF_CONDUCT.md']"));
  return [
          hasSecurityMd,
          hasCodeOfConduct
        ];
}

function calculateRiskScore(result) {
  var score = 0;
  score = score + Math.imul(result.highSeverity, 30) | 0;
  score = score + Math.imul(result.mediumSeverity, 15) | 0;
  score = score + Math.imul(result.lowSeverity, 5) | 0;
  if (!result.hasSecurityMd) {
    score = score + 10 | 0;
  }
  if (!result.hasCodeOfConduct) {
    score = score + 5 | 0;
  }
  return score;
}

function scanRepository() {
  var issues = [];
  var match = checkSecurityFiles();
  var hasCodeOfConduct = match[1];
  var hasSecurityMd = match[0];
  if (!hasSecurityMd) {
    ((issues.push(issue)));
  }
  if (!hasCodeOfConduct) {
    ((issues.push(issue)));
  }
  var highCount = {
    contents: 0
  };
  var mediumCount = {
    contents: 0
  };
  var lowCount = {
    contents: 0
  };
  Belt_Array.forEach(issues, (function (issue) {
          var match = issue.severity;
          switch (match) {
            case "High" :
                highCount.contents = highCount.contents + 1 | 0;
                return ;
            case "Medium" :
                mediumCount.contents = mediumCount.contents + 1 | 0;
                return ;
            case "Low" :
                lowCount.contents = lowCount.contents + 1 | 0;
                return ;
            
          }
        }));
  var result_totalIssues = issues.length;
  var result_highSeverity = highCount.contents;
  var result_mediumSeverity = mediumCount.contents;
  var result_lowSeverity = lowCount.contents;
  var result = {
    totalIssues: result_totalIssues,
    highSeverity: result_highSeverity,
    mediumSeverity: result_mediumSeverity,
    lowSeverity: result_lowSeverity,
    issues: issues,
    hasSecurityMd: hasSecurityMd,
    hasCodeOfConduct: hasCodeOfConduct,
    riskScore: 0
  };
  var riskScore = calculateRiskScore(result);
  return {
          totalIssues: result_totalIssues,
          highSeverity: result_highSeverity,
          mediumSeverity: result_mediumSeverity,
          lowSeverity: result_lowSeverity,
          issues: issues,
          hasSecurityMd: hasSecurityMd,
          hasCodeOfConduct: hasCodeOfConduct,
          riskScore: riskScore
        };
}

var css = "\n.grim-security-panel {\n  position: fixed;\n  top: 80px;\n  right: 20px;\n  width: 400px;\n  max-height: 600px;\n  overflow-y: auto;\n  background: linear-gradient(135deg, #4a1a1a 0%, #1a1a2e 100%);\n  border: 1px solid #7a4a4a;\n  border-radius: 8px;\n  padding: 20px;\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n  color: #e0e0e0;\n  font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  z-index: 10000;\n}\n\n.grim-security-header {\n  font-size: 18px;\n  font-weight: 600;\n  margin-bottom: 15px;\n  color: #f44336;\n}\n\n.grim-security-score {\n  text-align: center;\n  padding: 15px;\n  margin-bottom: 15px;\n  border-radius: 8px;\n  background: rgba(255, 255, 255, 0.05);\n}\n\n.grim-security-score-value {\n  font-size: 36px;\n  font-weight: 700;\n  margin-bottom: 5px;\n}\n\n.grim-security-score-label {\n  font-size: 11px;\n  color: #999;\n  text-transform: uppercase;\n  letter-spacing: 1px;\n}\n\n.grim-security-stats {\n  display: flex;\n  gap: 10px;\n  margin-bottom: 15px;\n}\n\n.grim-security-stat {\n  flex: 1;\n  text-align: center;\n  padding: 10px;\n  border-radius: 6px;\n  background: rgba(255, 255, 255, 0.05);\n}\n\n.grim-security-stat-value {\n  font-size: 24px;\n  font-weight: 700;\n}\n\n.grim-security-stat-label {\n  font-size: 10px;\n  color: #999;\n  text-transform: uppercase;\n  margin-top: 4px;\n}\n\n.grim-security-stat.high .grim-security-stat-value {\n  color: #f44336;\n}\n\n.grim-security-stat.medium .grim-security-stat-value {\n  color: #ff9800;\n}\n\n.grim-security-stat.low .grim-security-stat-value {\n  color: #2196f3;\n}\n\n.grim-security-issue {\n  padding: 10px;\n  margin-bottom: 8px;\n  border-left: 3px solid;\n  border-radius: 4px;\n  background: rgba(255, 255, 255, 0.05);\n}\n\n.grim-security-issue.high {\n  border-color: #f44336;\n}\n\n.grim-security-issue.medium {\n  border-color: #ff9800;\n}\n\n.grim-security-issue.low {\n  border-color: #2196f3;\n}\n\n.grim-security-issue-category {\n  font-size: 10px;\n  color: #999;\n  text-transform: uppercase;\n  letter-spacing: 1px;\n}\n\n.grim-security-issue-desc {\n  font-size: 13px;\n  font-weight: 600;\n  margin: 4px 0;\n}\n\n.grim-security-issue-remediation {\n  font-size: 11px;\n  color: #999;\n  font-style: italic;\n}\n\n.grim-security-close {\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  background: none;\n  border: none;\n  color: #999;\n  font-size: 24px;\n  cursor: pointer;\n  width: 30px;\n  height: 30px;\n  line-height: 1;\n  padding: 0;\n}\n\n.grim-security-close:hover {\n  color: #fff;\n}\n";

function severityToClass(sev) {
  switch (sev) {
    case "High" :
        return "high";
    case "Medium" :
        return "medium";
    case "Low" :
        return "low";
    
  }
}

function createPanel(result) {
  GrimCore.DOM.create("div", "grim-security-panel", undefined);
  Belt_Array.map(Belt_Array.slice(result.issues, 0, 15), (function (issue) {
            var sevClass = severityToClass(issue.severity);
            return "<div class=\"grim-security-issue " + sevClass + "\">\n          <div class=\"grim-security-issue-category\">" + issue.category + "</div>\n          <div class=\"grim-security-issue-desc\">" + issue.description + "</div>\n          <div class=\"grim-security-issue-remediation\">" + issue.remediation + "</div>\n        </div>";
          })).join("");
  ((panel.innerHTML = "<div class='grim-security-header'>Security Scan</div>" +
    "<div class='grim-security-score'><div class='grim-security-score-value' style='color:" + riskColor + "'>" + result.riskScore + "</div><div class='grim-security-score-label'>Risk Score</div></div>" +
    "<div class='grim-security-stats'><div class='grim-security-stat high'><div class='grim-security-stat-value'>" + result.highSeverity + "</div><div class='grim-security-stat-label'>High</div></div>" +
    "<div class='grim-security-stat medium'><div class='grim-security-stat-value'>" + result.mediumSeverity + "</div><div class='grim-security-stat-label'>Medium</div></div>" +
    "<div class='grim-security-stat low'><div class='grim-security-stat-value'>" + result.lowSeverity + "</div><div class='grim-security-stat-label'>Low</div></div></div>" +
    issuesList));
  ((document.createElement("button")));
  ((closeBtn.textContent = "Ã—"));
  ((closeBtn.className = "grim-security-close"));
  ((closeBtn.onclick = () => panel.remove()));
  ((panel.appendChild(closeBtn)));
  ((document.body.appendChild(panel)));
}

function run() {
  GrimCore.Log.info("GrimSecurityScanner running");
  GM_addStyle(css);
  var result = scanRepository();
  createPanel(result);
}

if (GrimCore.$$URL.isGitHub() || GrimCore.$$URL.isGitLab()) {
  GM_registerMenuCommand("Run Security Scan", (function () {
          run();
        }));
}

export {
  secretPatterns ,
  dangerousPatterns ,
  insecureDependencies ,
  detectSecrets ,
  detectDangerousCode ,
  checkSecurityFiles ,
  calculateRiskScore ,
  scanRepository ,
  css ,
  severityToClass ,
  createPanel ,
  run ,
}
/*  Not a pure module */
